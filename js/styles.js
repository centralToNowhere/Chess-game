!function(){function modeToggle(e){if("keydown"===e.type){if(13!==e.keyCode)return;e.preventDefault()}prev!==this&&(prev.removeAttribute("checked"),prev=this),this.setAttribute("checked","checked"),"check_single"!==this.htmlFor&&"single"!==this.dataset.check||(document.querySelector("#game_pass").setAttribute("disabled","disabled"),document.querySelector("#game_name").setAttribute("disabled","disabled"),document.querySelector('.game-auth > input[type="submit"]').focus()),"check_multi"!==this.htmlFor&&"multi"!==this.dataset.check||(document.querySelector("#game_pass").removeAttribute("disabled"),document.querySelector("#game_name").removeAttribute("disabled"),document.querySelector(".game-auth > #game_name").focus())}for(var rads=document.querySelector(".game-auth").mode,prev=document.querySelector("#check_multi"),i=0;i<rads.length;i++)rads[i].addEventListener("click",modeToggle),rads[i].nextElementSibling.addEventListener("keydown",modeToggle.bind(rads[i]));document.querySelector(".game-auth").addEventListener("submit",function(e){document.querySelector(".block-notification").innerHTML="",(e=e||window.e).preventDefault?e.preventDefault():e.returnValue=!1,!0===document.querySelector("#check_multi").checked?alert("Mode is not available with static web server"):(positions.game_mode="single",positions.current_move=!0,positions.current_side="white",loadScript("js/chessBot.js",function(){function undo_func(e){this.classList.add("active");var that=this;e.stopPropagation(),window.Worker&&workerInProgress||setTimeout(function(){positions.tools.undo(),positions.render(),that.classList.remove("active")},0)}function forward_func(e){this.classList.add("active");var that=this;e.stopPropagation(),window.Worker&&!workerInProgress?"black"===positions.win||"white"===positions.win?that.classList.remove("active"):positions.tools.ai_move():workerInProgress||setTimeout(function(){"black"===positions.win||"white"===positions.win||positions.tools.ai_move(),that.classList.remove("active")},0)}function autoplay_func(e){e.stopPropagation(),this.classList.toggle("active");var circle=function(){autoplay_func.isWorking&&(""===positions.win?(positions.tools.ai_move(),setTimeout(circle,0)):(autoplay.classList.toggle("active"),undo_arrow.addEventListener("click",undo_func),forward_arrow.addEventListener("click",forward_func)))};this.classList.contains("active")?(undo_arrow.removeEventListener("click",undo_func),forward_arrow.removeEventListener("click",forward_func),window.Worker?(document.addEventListener("workerReady",workerCircle),workerInProgress||workerCircle()):setTimeout(function(){autoplay_func.isWorking=!0,circle()},0)):(window.Worker?document.removeEventListener("workerReady",workerCircle):autoplay_func.isWorking=!1,undo_arrow.addEventListener("click",undo_func),forward_arrow.addEventListener("click",forward_func))}var bot=new ChessBot(positions),workerInProgress=!1,icon_menu=(document.querySelector(".board-container"),document.querySelector(".container__icon-menu")),ai_settings=document.querySelector(".ai-settings"),icon_menu_wrapper=document.querySelector(".container__icon-menu_wrapper"),ai_settings_content=document.createElement("ul"),nodes_count_label=document.createElement("span"),nodes_count_div=document.createElement("div"),container__nodes_count=document.createElement("div"),pruning_label=document.createElement("span"),pruning_div=document.createElement("div"),container__pruning=document.createElement("div"),container__mobile_metrics=document.createElement("div"),progressBar=document.createElement("progress"),undo_arrow=document.createElement("img"),forward_arrow=document.createElement("img"),autoplay=document.createElement("img"),metrics=document.createElement("img"),workerCircle=(container__nodes_count.classList.add("container__ai-info-output"),container__pruning.classList.add("container__ai-info-output"),container__mobile_metrics.classList.add("container__mobile_metrics"),progressBar.classList.add("container__progressBar"),undo_arrow.src="./images/arrow.png",forward_arrow.src="./images/arrow.png",autoplay.src="./images/autoplay.png",metrics.src="./images/icon-metrics.png",undo_arrow.classList.add("container__undo-arrow"),forward_arrow.classList.add("container__forward-arrow"),autoplay.classList.add("container__auto"),metrics.classList.add("container__metrics"),ai_settings.appendChild(ai_settings_content),ai_settings_content.outerHTML='<ul class="ai-settings__list">Search algorithm <li class="ai-settings__item">Minimax <input type="radio" name="check_algo" value="minimax" id="algo_minimax"> <label for="algo_minimax"></label> </li><li class="ai-settings__item">Alpha-Beta <input type="radio" name="check_algo" value="alphaBeta" id="algo_alphaBeta" checked> <label for="algo_alphaBeta"></label> <ul class="ai-settings__list"> <li class="ai-settings__item">Ordering <input type="checkbox" id="algo_alphaBeta_ordering" checked> <label for="algo_alphaBeta_ordering"></label> </li></ul> </li><li class="ai-settings__item">NegaScout <input type="radio" name="check_algo" value="negaScout" id="algo_negaScout"> <label for="algo_negaScout"></label> </li><li class="ai-settings__item"> Depth <div class="ai-settings__item-select-div"> <select name="depth"> <option value="2">2</option> <option value="3" selected>3</option> <option value="4">4</option> <option value="5">5</option> </select> <div class="ai-settings__item-select">3</div><ul class="ai-settings__item-select-list"> <li class="ai-settings__item-select-item" data-value="2">2</li><li class="ai-settings__item-select-item" data-value="3">3</li><li class="ai-settings__item-select-item" data-value="4">4</li><li class="ai-settings__item-select-item" data-value="5">5</li></ul> </div></li><li class="ai-settings__item">Evaluation <ul class="ai-settings__list"> <li class="ai-settings__item"> Material <input type="checkbox" id="check_eval_material" checked> <label for="check_eval_material"></label> </li><li class="ai-settings__item"> Position <input type="checkbox" id="check_eval_position" checked> <label for="check_eval_position"></label> </li></ul> </li></ul>',nodes_count_label.textContent="Checked nodes: ",pruning_label.textContent="Cut-offs: ",document.querySelector(".ai-settings__x-mark-menu p").innerHTML="Settings",container__nodes_count.appendChild(nodes_count_label),container__nodes_count.appendChild(nodes_count_div),container__pruning.appendChild(pruning_label),container__pruning.appendChild(pruning_div),icon_menu.appendChild(icon_menu_wrapper),icon_menu_wrapper.appendChild(undo_arrow),icon_menu_wrapper.appendChild(autoplay),icon_menu_wrapper.appendChild(forward_arrow),icon_menu_wrapper.appendChild(metrics),icon_menu_wrapper.appendChild(container__nodes_count),icon_menu_wrapper.parentNode.insertBefore(container__mobile_metrics,icon_menu_wrapper.nextElementSibling),function(){""===positions.win?positions.tools.ai_move():(document.removeEventListener("workerReady",workerCircle),this.classList.toggle("active"),undo_arrow.addEventListener("click",undo_func),forward_arrow.addEventListener("click",forward_func))}.bind(autoplay)),ai_settings=(window.Worker&&icon_menu_wrapper.appendChild(container__pruning),pruning_div.textContent="0.00%",nodes_count_div.textContent="0",console.log("ChessBot loaded"),document.body.addEventListener("AI_turn",function(){if(document.querySelector(".king_"+positions.current_side).click(),document.body.click(),""!==positions.win)return pruning_div.textContent="0.00%",void(nodes_count_div.textContent="0");var obj={};switch(algorithm=document.querySelector('input[name="check_algo"]:checked').value,pruning_div.textContent="0.00%",nodes_count_div.textContent="0",progressBar.value=0,icon_menu_wrapper.appendChild(progressBar),bot.set_side(positions.current_side),positions.ai_side=positions.current_side,algorithm){case"minimax":obj={pruning:!1,ordering:!0,depth:+document.getElementsByName("depth")[0].value,eval:{material:document.querySelector("#check_eval_material").checked,position:document.querySelector("#check_eval_position").checked},output:document.querySelector(".container__ai-output")};break;case"alphaBeta":obj={pruning:!0,ordering:document.querySelector("#algo_alphaBeta_ordering").checked,depth:+document.getElementsByName("depth")[0].value,eval:{material:document.querySelector("#check_eval_material").checked,position:document.querySelector("#check_eval_position").checked},output:document.querySelector(".container__ai-output")};break;case"negaScout":obj={depth:+document.getElementsByName("depth")[0].value,eval:{material:document.querySelector("#check_eval_material").checked,position:document.querySelector("#check_eval_position").checked},output:document.querySelector(".container__ai-output")}}var blob,partialCopy,serializeObject,positionsObj,copy,execAlgorithm=function(bot,algorithm,obj){switch(algorithm){case"minimax":case"alphaBeta":bot.alphaBeta(obj);break;case"negaScout":bot.negascout(obj)}}.bind(void 0,bot,algorithm,obj);window.Worker?(blob=new Blob(['self.addEventListener("message",function(e){self.isWorker=!0;var n=e.data[0],t=e.data[1],a=e.data[2],r=new Function("return "+e.data[3])(),c=function e(n){var t={},a=function(e){return/^function.*?(.*?)\\s*{(.|\\n)*}$/.test(e)};return Object.keys(n).forEach(function(r){a(n[r])?t[r]=new Function("return "+n[r])():null!==n[r]&&"object"==typeof n[r]?t[r]=e(n[r]):t[r]=n[r]}),t}(e.data[4]),u=function(){for(var e in n)c[e]=n[e];return c}(),s=new r(u);switch(s.set_side(u.current_side),t){case"minimax":case"alphaBeta":s.alphaBeta(a);break;case"negaScout":s.negascout(a)}});'],{type:"application/javascript"}),(blob=new Worker(URL.createObjectURL(blob))).addEventListener("message",function(e){var property,subject=e.data.shift();if("positions"===subject)"execute_move"===(property=e.data.shift())?(e.data.push(positions),positions[property].apply(positions,e.data)()):"function"==typeof positions[property]?positions[property].apply(positions,e.data):positions[property]=e.data[0];else{if("status"===subject)return"finished"===(property=e.data.shift())&&(workerInProgress=!1,forward_arrow.classList.remove("active"),document.querySelector(".king_"+positions.current_side).click(),document.body.click(),"DIV"===progressBar.nodeName?progressBar.style.width="0":"PROGRESS"===progressBar.nodeName&&(progressBar.value="0"),icon_menu_wrapper.removeChild(progressBar),positions.ai_output_pruning_sum=0,positions.ai_output_researched_sum=0,console.log("finished"),document.dispatchEvent(new Event("workerReady"))),this.terminate();if("guiUpdate"===subject){if("nodes"===(property=e.data.shift()))return void positions.tools.ai_output_nodes_checked(e.data[0]);if("progressBar"===property)return void positions.tools.ai_output_progressBar(e.data[0],e.data[1]);if("pruning"===property)return void positions.tools.ai_output_pruning(e.data[0],e.data[1],e.data[2])}"storage"===subject&&"cuttOffAccuracyTest"===(property=e.data.shift())&&localStorage.setItem("cuttOffAccuracyTest",localStorage.getItem("cuttOffAccuracyTest")?localStorage.getItem("cuttOffAccuracyTest")+" "+e.data.shift()+" "+e.data.shift()+" "+e.data.shift()+" "+e.data.shift():e.data.shift()+" "+e.data.shift()+" "+e.data.shift()+" "+e.data.shift())}}),partialCopy={},serializeObject=function(object){var serialized={};return Object.keys(object).forEach(function(key){null!==object[key]&&"object"==typeof object[key]?serialized[key]=serializeObject(object[key]):null!==object[key]?serialized[key]=object[key].toString():serialized[key]=object[key]}),serialized},positionsObj=positions,copy={},["call","data","matrix","is_it_a_first_move","password","move_status","current_side","current_move","name","game_status","win","check","game_mode","ai_side","AI","moves_stack"].forEach(function(p){copy[p]=positionsObj[p]}),partialCopy=copy,serializedPositions=serializeObject(positions),workerInProgress=!0,blob.postMessage([partialCopy,algorithm,obj,ChessBot.toString(),serializedPositions])):execAlgorithm()}),undo_arrow.addEventListener("click",undo_func),forward_arrow.addEventListener("click",forward_func),autoplay.addEventListener("click",autoplay_func),metrics.addEventListener("click",function(e){function showMobileMetrics(elem_metrics){elem_metrics.parentNode===icon_menu_wrapper?(icon_menu_wrapper.removeChild(elem_metrics),container__mobile_metrics.appendChild(elem_metrics)):(container__mobile_metrics.removeChild(elem_metrics),icon_menu_wrapper.appendChild(elem_metrics))}e.stopPropagation(),this.classList.toggle("active"),showMobileMetrics(container__nodes_count),showMobileMetrics(container__pruning)}),document.addEventListener("keydown",function(e){if("39"!=e.keyCode&&"68"!=e.keyCode||e.ctrlKey||e.shiftKey||e.altKey)return"37"!=e.keyCode&&"65"!=e.keyCode||e.ctrlKey||e.shiftKey||e.altKey?void("82"!=e.keyCode||e.ctrlKey||e.shiftKey||e.altKey||(e.stopPropagation(),autoplay_func.call(autoplay,e))):(e.stopPropagation(),void undo_func.call(undo_arrow,e));e.stopPropagation(),forward_func.call(forward_arrow,e)}),document.querySelector(".container-fluid ").style.display="block",document.querySelector(".modal").style.display="none",[].forEach.call(document.querySelectorAll(".ai-settings__item-select"),function(select){select.style.width=+getComputedStyle(select.nextElementSibling).width.substr(0,getComputedStyle(select.nextElementSibling).width.search("px"))+20+"px",select.addEventListener("click",function(e){e.stopPropagation(),select.classList.toggle("active"),select.nextElementSibling.classList.toggle("active")})}),[].forEach.call(document.querySelectorAll(".ai-settings__item-select-item"),function(item){item.addEventListener("click",function(e){e.stopPropagation(),this.parentNode.previousElementSibling.innerHTML=this.dataset.value;var that=this;this.parentNode.classList.toggle("active"),this.parentNode.previousElementSibling.classList.toggle("active"),[].forEach.call(this.parentNode.parentNode.querySelector("select").children,function(elem){elem.removeAttribute("selected","selected"),elem.value===that.dataset.value&&elem.setAttribute("selected","selected")})})}),document.body.addEventListener("click",function(){document.querySelectorAll(".ai-settings__item-select-list").forEach(function(list){list.classList.contains("active")&&(list.classList.remove("active"),list.previousElementSibling.classList.remove("active"))})}),scale(),window.addEventListener("optimizedResize",scale,!1),positions.tools.set_output_nodes_checked(nodes_count_div),positions.tools.set_output_progressBar(progressBar),positions.tools.set_output_pruning(pruning_div),positions.render(),positions.set_possible_moves(),document.querySelector(".king_"+positions.current_side));ai_settings.addEventListener("click_king",function(){this.click(),document.body.click()}),ai_settings.dispatchEvent(e)}),document.querySelector(".ai-settings__x-mark-menu").firstElementChild.addEventListener("click",function(e){e.stopPropagation(),this.parentNode.parentNode.parentNode.classList.remove("row-compressed")}),document.querySelector(".ai-settings__x-mark-menu").firstElementChild.addEventListener("keydown",function(e){"13"==e.keyCode&&this.parentNode.parentNode.parentNode.classList.remove("row-compressed")}),document.querySelector(".container__menu-button").addEventListener("click",function(e){e.stopPropagation(),this.parentNode.parentNode.parentNode.classList.add("row-compressed")}),document.querySelector(".container__menu-button").addEventListener("keydown",function(e){"13"==e.keyCode&&this.parentNode.parentNode.parentNode.classList.add("row-compressed")}))},!1)}();var chat={set_pushFunction:function(obj,fn){this.pushFunction=fn.bind(obj)},chat_subscribe:function(id,game){var xhr=new XMLHttpRequest,data=(xhr.open("POST","/chat_subscribe",!0),{id:id,name:game});xhr.send(JSON.stringify(data)),xhr.onload=function(){try{console.log("RESPONSE",xhr.responseText);var data=JSON.parse(xhr.responseText),message=void 0!==data.message?data.message:"",whose=data.whose;this.pushFunction(message,whose)}catch(e){console.log(e)}chat.chat_subscribe(id,game)}.bind(this)},chat_publish:function(id,game,message){id={id:id,name:game,message:message},game=new XMLHttpRequest;game.open("POST","/chat_publish",!0),game.send(JSON.stringify(id))}},scale=(!function(){var type,name,obj,running;type="resize",name="optimizedResize",obj=obj||window,running=!1,obj.addEventListener(type,function(){running||(running=!0,requestAnimationFrame(function(){obj.dispatchEvent(new CustomEvent(name)),running=!1}))})}(),!function(){var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;window.requestAnimationFrame=requestAnimationFrame}(),function(){function setSidebarAiSettingsHeight(){setSidebarAiSettingsHeight.ai_settings=setSidebarAiSettingsHeight.ai_settings||document.querySelector(".ai-settings");var currentUsedHeight=getComputedStyle(setSidebarAiSettingsHeight.ai_settings).height,clientH=document.documentElement.clientHeight;clientH>parseInt(currentUsedHeight)&&(setSidebarAiSettingsHeight.ai_settings.style.height=clientH+"px")}return function(){if(setSidebarAiSettingsHeight(),document.documentElement.clientWidth<=510)for(var cells=document.querySelectorAll(".board__cell"),width=cells[0].offsetWidth,h=0;h<cells.length;h++)cells[h].style.height=width+"px"}}()),loadScript=function(src,callback){var script=document.createElement("script"),afterLoad=function(){};return function(callback){afterLoad=callback}(callback),function(src){script.src=src,document.body.appendChild(script),script.onload=script.onerror=function(){this.executed||(this.executed=!0,afterLoad())},script.onreadystatechange=function(){var self=this;"complete"!=this.readyState&&"loaded"!=this.readyState||setTimeout(function(){self.onload()},0)}}(src),{}},testCutOffAcc=function(){var arr=localStorage.getItem("cuttOffAccuracyTest").split(" "),res=[],resObj={};arr.forEach(function(a,index){index%8||res.push({errHardPred:Math.abs(100-a/arr[index+4]*100-arr[index+2]),errEasePred:Math.abs(100-a/arr[index+4]*100-arr[index+3]),errMinimax:Math.abs((arr[index+1]-arr[index+4])/arr[index+4]*100)})}),resObj.average=function(){var i,r={},obj=res.reduce(function(a,b){return{errHardPred:a.errHardPred+b.errHardPred,errEasePred:a.errEasePred+b.errEasePred,errMinimax:a.errMinimax+b.errMinimax}});for(i in obj)r[i]=obj[i]/(arr.length/8);return r}(),resObj.median=function(){var i,c,r={},tmp={errHardPred:[],errEasePred:[],errMinimax:[]};for(i in res.forEach(function(a){tmp.errHardPred.push(a.errHardPred),tmp.errEasePred.push(a.errEasePred),tmp.errMinimax.push(a.errMinimax)}),tmp)r[i]=((c=tmp[i]).sort(function(a,b){return a-b}),c.length%2!=0?c[(c.length-1)/2]:(c[c.length/2]+c[c.length/2-1])/2);return r}(),console.log("Average: \n"),console.log("        errHardPred:"+resObj.average.errHardPred+"\n"),console.log("        errEasePred:"+resObj.average.errEasePred+"\n"),console.log("        errMinimaxPred:"+resObj.average.errMinimax+"\n"),console.log("Median: \n"),console.log("        errHardPred:"+resObj.median.errHardPred+"\n"),console.log("        errEasePred:"+resObj.median.errEasePred+"\n"),console.log("        errMinimaxPred:"+resObj.median.errMinimax+"\n"),localStorage.removeItem("cuttOffAccuracyTest")};